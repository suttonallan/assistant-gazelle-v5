<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VDI — Notes Technicien</title>
  <style>
    :root {
      --green: #22c55e; --green-bg: #f0fdf4;
      --blue: #3b82f6; --blue-bg: #eff6ff;
      --gray: #6b7280; --gray-bg: #f9fafb;
      --border: #e5e7eb; --saved: #16a34a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f3f4f6; color: #111827; padding-bottom: 2rem;
    }
    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
      color: white; padding: 1rem; text-align: center;
      position: sticky; top: 0; z-index: 50;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    header .subtitle { font-size: 0.8rem; opacity: 0.85; margin-top: 0.25rem; }
    .status-bar {
      background: #fefce8; border-bottom: 1px solid #fde68a;
      padding: 0.4rem 1rem; font-size: 0.75rem; text-align: center; color: #92400e;
    }
    .status-bar.saved { background: #f0fdf4; border-color: #bbf7d0; color: var(--saved); }
    .status-bar.error { background: #fef2f2; border-color: #fecaca; color: #dc2626; }

    .piano-card {
      background: white; margin: 0.75rem; border-radius: 0.75rem;
      border: 1px solid var(--border); overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .piano-card.priority { border-left: 4px solid var(--green); }
    .piano-header {
      padding: 0.75rem 1rem; display: flex; align-items: center;
      justify-content: space-between; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .piano-header:active { background: var(--gray-bg); }
    .piano-info h3 { font-size: 0.95rem; font-weight: 600; }
    .piano-info .location { font-size: 0.8rem; color: var(--gray); }
    .piano-badges { display: flex; gap: 0.4rem; align-items: center; }
    .badge {
      font-size: 0.65rem; padding: 0.15rem 0.5rem; border-radius: 999px;
      font-weight: 600; white-space: nowrap;
    }
    .badge.prio { background: var(--green-bg); color: var(--green); }
    .badge.draft { background: var(--blue-bg); color: var(--blue); }
    .badge.saved-badge { background: var(--green-bg); color: var(--saved); }
    .chevron {
      transition: transform 0.2s; font-size: 1.2rem; color: var(--gray);
    }
    .chevron.open { transform: rotate(90deg); }

    .piano-body { display: none; padding: 0 1rem 1rem; }
    .piano-body.open { display: block; }
    textarea {
      width: 100%; min-height: 120px; padding: 0.75rem;
      border: 1px solid var(--border); border-radius: 0.5rem;
      font-size: 0.9rem; resize: vertical; line-height: 1.5;
      font-family: inherit;
    }
    textarea:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
    .note-meta { font-size: 0.7rem; color: var(--gray); margin-top: 0.4rem; text-align: right; }

    .loading { text-align: center; padding: 3rem 1rem; color: var(--gray); }
    .loading .spinner {
      width: 2rem; height: 2rem; border: 3px solid var(--border);
      border-top-color: var(--blue); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-screen { text-align: center; padding: 3rem 1rem; color: #dc2626; }
    .counter { font-size: 0.75rem; color: var(--gray); padding: 0.5rem 1rem; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Vincent-d'Indy — Notes</h1>
    <div class="subtitle" id="techName">Chargement...</div>
  </header>
  <div class="status-bar" id="statusBar">Prêt</div>
  <div id="app">
    <div class="loading" id="loader">
      <div class="spinner"></div>
      <div>Chargement des pianos...</div>
    </div>
  </div>

<script>
(function() {
  // ---------- Config ----------
  const API_BASE = window.location.origin.includes('localhost')
    ? 'http://localhost:8000'
    : 'https://assistant-gazelle-v5-api.onrender.com';

  // Extraire le token du hash : /vdi-guest.html#TOKEN
  const TECH_TOKEN = window.location.hash.replace('#', '').trim();
  if (!TECH_TOKEN) {
    document.getElementById('app').innerHTML =
      '<div class="error-screen"><h2>Lien invalide</h2><p>Aucun token trouvé dans l\'URL.</p></div>';
    return;
  }

  const statusBar = document.getElementById('statusBar');
  const app = document.getElementById('app');
  let debounceTimers = {};

  // ---------- API ----------
  async function apiGet(path) {
    const r = await fetch(API_BASE + path);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
  async function apiPut(path, body) {
    const r = await fetch(API_BASE + path, {
      method: 'PUT', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  // ---------- Status ----------
  function setStatus(msg, type) {
    statusBar.textContent = msg;
    statusBar.className = 'status-bar' + (type ? ' ' + type : '');
  }

  // ---------- Render ----------
  function renderPianos(data) {
    document.getElementById('techName').textContent = data.tech_name;
    document.title = `VDI — ${data.tech_name}`;

    let html = `<div class="counter">${data.count} pianos</div>`;

    data.pianos.forEach((p, i) => {
      const hasBuf = p.buffer_note && p.buffer_note.note;
      const isPrio = p.is_priority;
      const noteText = hasBuf ? p.buffer_note.note : '';
      const noteStatus = hasBuf ? p.buffer_note.status : '';
      const updatedAt = hasBuf && p.buffer_note.updated_at
        ? new Date(p.buffer_note.updated_at).toLocaleTimeString('fr-CA', {hour:'2-digit', minute:'2-digit'})
        : '';

      html += `
        <div class="piano-card${isPrio ? ' priority' : ''}" id="card-${p.id}">
          <div class="piano-header" onclick="toggleCard('${p.id}')">
            <div class="piano-info">
              <h3>${p.make || ''} ${p.model || ''}</h3>
              <div class="location">${p.location || 'Emplacement inconnu'}${p.serialNumber ? ' — ' + p.serialNumber : ''}</div>
            </div>
            <div class="piano-badges">
              ${isPrio ? '<span class="badge prio">Prioritaire</span>' : ''}
              ${hasBuf ? `<span class="badge ${noteStatus === 'draft' ? 'draft' : 'saved-badge'}">${noteStatus === 'draft' ? 'Brouillon' : 'Sauvé'}</span>` : ''}
              <span class="chevron" id="chev-${p.id}">›</span>
            </div>
          </div>
          <div class="piano-body" id="body-${p.id}">
            <textarea
              id="ta-${p.id}"
              placeholder="Notes d'accord, observations..."
              oninput="onNoteInput('${p.id}')"
            >${noteText}</textarea>
            <div class="note-meta" id="meta-${p.id}">${updatedAt ? 'Dernière sauvegarde : ' + updatedAt : ''}</div>
          </div>
        </div>`;
    });

    app.innerHTML = html;

    // Auto-ouvrir le premier piano prioritaire sans note
    const firstPrio = data.pianos.find(p => p.is_priority && (!p.buffer_note || !p.buffer_note.note));
    if (firstPrio) toggleCard(firstPrio.id);
  }

  // ---------- Interactions ----------
  window.toggleCard = function(pid) {
    const body = document.getElementById('body-' + pid);
    const chev = document.getElementById('chev-' + pid);
    const isOpen = body.classList.contains('open');
    body.classList.toggle('open');
    chev.classList.toggle('open');
    if (!isOpen) {
      setTimeout(() => document.getElementById('ta-' + pid).focus(), 100);
    }
  };

  window.onNoteInput = function(pid) {
    clearTimeout(debounceTimers[pid]);
    debounceTimers[pid] = setTimeout(() => saveNote(pid), 500);
  };

  async function saveNote(pid) {
    const ta = document.getElementById('ta-' + pid);
    const note = ta.value.trim();
    if (!note) return;

    setStatus('Sauvegarde...', '');
    try {
      await apiPut(`/vdi/guest/${TECH_TOKEN}/pianos/${pid}/note`, { note });
      setStatus('Sauvegardé ✓', 'saved');
      const meta = document.getElementById('meta-' + pid);
      meta.textContent = 'Dernière sauvegarde : ' + new Date().toLocaleTimeString('fr-CA', {hour:'2-digit', minute:'2-digit'});
    } catch (e) {
      setStatus('Erreur de sauvegarde', 'error');
      console.error(e);
    }
  }

  // ---------- Init ----------
  async function init() {
    try {
      const data = await apiGet(`/vdi/guest/${TECH_TOKEN}/pianos`);
      renderPianos(data);
      setStatus('Prêt — tapez vos notes, elles se sauvegardent automatiquement', '');
    } catch (e) {
      app.innerHTML = `<div class="error-screen">
        <h2>Erreur</h2>
        <p>${e.message || 'Impossible de charger les pianos.'}</p>
        <p style="margin-top:1rem;font-size:0.8rem;color:#6b7280">Vérifiez le lien ou contactez Nicolas.</p>
      </div>`;
    }
  }

  init();
})();
</script>
</body>
</html>
