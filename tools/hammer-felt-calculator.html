<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculateur Feutrage / Hammer Felt Calculator</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }

  .header { background: #16213e; padding: 16px 24px; border-bottom: 2px solid #0f3460; display: flex; align-items: center; gap: 12px; }
  .header h1 { font-size: 20px; color: #e94560; }
  .header span { font-size: 13px; color: #888; }
  .lang-toggle { margin-left: auto; display: flex; gap: 0; border-radius: 6px; overflow: hidden; border: 1px solid #0f3460; }
  .lang-btn { padding: 6px 14px; cursor: pointer; font-size: 13px; font-weight: 600; border: none; background: #1a1a2e; color: #888; transition: all 0.2s; }
  .lang-btn.active { background: #e94560; color: #fff; }
  .lang-btn:hover:not(.active) { background: #0f3460; color: #ccc; }

  .tabs { display: flex; background: #16213e; border-bottom: 1px solid #0f3460; }
  .tab { padding: 12px 24px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab:hover { color: #ccc; }
  .tab.active { color: #e94560; border-bottom-color: #e94560; }

  .content { max-width: 1200px; margin: 0 auto; padding: 24px; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* Calculator Input */
  .calc-input { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; margin-bottom: 24px; }
  .calc-input label { font-size: 13px; color: #aaa; display: block; margin-bottom: 4px; }
  .calc-input input, .calc-input select { background: #16213e; border: 1px solid #0f3460; color: #eee; padding: 10px 14px; border-radius: 6px; font-size: 16px; width: 160px; }
  .calc-input button { background: #e94560; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
  .calc-input button:hover { background: #c73e54; }

  /* Recommendation Tiles */
  .rec-tiles { display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
  .rec-tile { background: #16213e; border-radius: 10px; padding: 16px; border: 2px solid #0f3460; text-align: center; }
  .rec-tile.felt-tile { background: linear-gradient(135deg, #8b0000, #c0392b); border-color: #e94560; }
  .rec-tile .tile-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: #aaa; margin-bottom: 6px; }
  .rec-tile.felt-tile .tile-label { color: rgba(255,255,255,0.7); }
  .rec-tile .tile-value { font-size: 22px; font-weight: 800; color: #4ecca3; line-height: 1.2; }
  .rec-tile.felt-tile .tile-value { font-size: 42px; color: #fff; }
  .rec-tile .tile-sub { font-size: 11px; color: #888; margin-top: 4px; }
  .rec-tile.felt-tile .tile-sub { color: rgba(255,255,255,0.6); }
  .rec-tile .tile-source { font-size: 10px; color: #555; margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); }
  .rec-tile.felt-tile .tile-source { color: rgba(255,255,255,0.4); }
  .rec-tile.confidence-high { border-color: #4ecca3; }
  .rec-tile.confidence-medium { border-color: #3a9d7c; }
  .rec-tile.confidence-low { border-color: #f5a623; }
  .rec-tile.confidence-none { border-color: #555; }

  /* Range bar */
  .range-bar { display: flex; align-items: center; gap: 4px; margin: 12px 0; height: 32px; }
  .range-segment { height: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; min-width: 40px; padding: 0 6px; }
  .seg-loose { background: #e94560; }
  .seg-ok { background: #4ecca3; }
  .seg-tight { background: #f5a623; }

  /* Bounds bar */
  .bounds-bar { display: flex; justify-content: center; gap: 24px; margin-bottom: 20px; font-size: 13px; padding: 8px; background: #16213e; border-radius: 6px; }

  /* History matches */
  .history-match { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #0f3460; font-size: 13px; }
  .history-match:last-child { border-bottom: none; }
  .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .badge-parfait { background: #4ecca3; color: #1a1a2e; }
  .badge-ok { background: #3a9d7c; color: #1a1a2e; }
  .badge-lache { background: #e94560; color: white; }
  .badge-serre { background: #f5a623; color: #1a1a2e; }

  /* Feedback form */
  .feedback-form { background: #0f1a2e; border: 2px dashed #0f3460; border-radius: 10px; padding: 20px; margin-top: 20px; }
  .feedback-form h3 { color: #4ecca3; margin-bottom: 16px; font-size: 15px; }
  .feedback-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
  .feedback-grid .fg { display: flex; flex-direction: column; }
  .feedback-grid .fg.wide { grid-column: span 2; }
  .feedback-grid .fg.full { grid-column: 1 / -1; }
  .feedback-grid label { font-size: 12px; color: #888; margin-bottom: 3px; }
  .feedback-grid input, .feedback-grid select, .feedback-grid textarea { background: #16213e; border: 1px solid #0f3460; color: #eee; padding: 8px; border-radius: 5px; font-size: 13px; }
  .feedback-grid textarea { resize: vertical; min-height: 40px; }
  .feedback-actions { margin-top: 12px; display: flex; gap: 12px; }

  /* Detail panel (collapsible) */
  .detail-toggle { color: #888; font-size: 12px; cursor: pointer; text-align: center; margin-top: 8px; }
  .detail-toggle:hover { color: #aaa; }
  .detail-panel { background: #16213e; border-radius: 8px; padding: 16px; margin-top: 12px; }
  .detail-panel h4 { font-size: 13px; color: #e94560; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  .rec-detail { font-size: 13px; color: #aaa; margin: 4px 0; }

  /* Old results grid (kept for history detail) */
  .results { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .result-card { background: #16213e; border-radius: 8px; padding: 16px; border: 1px solid #0f3460; }
  .result-card h3 { font-size: 14px; color: #e94560; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .result-card.full { grid-column: 1 / -1; }

  /* Form */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label { font-size: 13px; color: #aaa; margin-bottom: 4px; }
  .form-group input, .form-group select, .form-group textarea { background: #16213e; border: 1px solid #0f3460; color: #eee; padding: 10px; border-radius: 6px; font-size: 14px; }
  .form-group textarea { resize: vertical; min-height: 60px; }
  .form-actions { margin-top: 16px; display: flex; gap: 12px; }
  .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; }
  .btn-primary { background: #e94560; color: white; }
  .btn-primary:hover { background: #c73e54; }
  .btn-save { background: #4ecca3; color: #1a1a2e; }
  .btn-save:hover { background: #3db890; }
  .btn-secondary { background: #0f3460; color: #aaa; }
  .btn-secondary:hover { background: #16213e; color: #eee; }

  /* Data table */
  .table-actions { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .table-actions select, .table-actions input { background: #16213e; border: 1px solid #0f3460; color: #eee; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: #0f3460; padding: 10px 8px; text-align: left; font-weight: 600; color: #e94560; position: sticky; top: 0; }
  td { padding: 8px; border-bottom: 1px solid #0f3460; }
  tr:hover { background: #16213e; }
  tr.outlier { opacity: 0.4; text-decoration: line-through; }
  .delete-btn { background: none; border: none; color: #e94560; cursor: pointer; font-size: 16px; padding: 2px 4px; }
  .delete-btn:hover { opacity: 0.7; }
  .outlier-cb { width: 16px; height: 16px; cursor: pointer; }

  /* Stock */
  .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
  .stock-card { background: #16213e; border-radius: 8px; padding: 12px; border: 1px solid #0f3460; }
  .stock-card .name { font-weight: 600; color: #4ecca3; }
  .stock-card .thickness { font-size: 13px; color: #aaa; }
  .stock-card .qty { font-size: 20px; font-weight: 700; margin-top: 4px; }
  .stock-card .qty.low { color: #e94560; }

  .toast { position: fixed; bottom: 24px; right: 24px; background: #4ecca3; color: #1a1a2e; padding: 12px 20px; border-radius: 8px; font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 100; }
  .toast.show { transform: translateY(0); opacity: 1; }

  @media (max-width: 768px) {
    .rec-tiles { grid-template-columns: 1fr; }
    .feedback-grid { grid-template-columns: 1fr 1fr; }
    .results { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .calc-input { flex-direction: column; }
    .calc-input input, .calc-input select { width: 100%; }
  }
</style>
</head>
<body>

<div class="header">
  <h1 data-t="header_title">Calculateur Feutrage</h1>
  <span data-t="header_subtitle">Marteaux de piano - Cales & Feutres</span>
  <div class="lang-toggle">
    <button class="lang-btn active" id="langFR" onclick="setLang('fr')">FR</button>
    <button class="lang-btn" id="langEN" onclick="setLang('en')">EN</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('calc')" data-t="tab_calc">Calculateur</div>
  <div class="tab" onclick="showTab('entry')" data-t="tab_entry">Saisie</div>
  <div class="tab" onclick="showTab('data')" data-t="tab_history">Historique</div>
  <div class="tab" onclick="showTab('stock')" data-t="tab_stock">Inventaire</div>
</div>

<div class="content">

  <!-- CALCULATEUR -->
  <div id="calc" class="panel active">
    <div class="calc-input">
      <div>
        <label data-t="calc_pin_label">Taille de la pointe (pouces)</label>
        <input type="number" id="pinSize" step="0.001" min="0.05" max="0.25" placeholder=".146">
      </div>
      <div>
        <label data-t="calc_sizing_label">Sizing / Mortaise</label>
        <select id="sizingSelect" onchange="onSizingSelect()">
          <option value="" data-t="opt_choose">-- Choisir --</option>
          <option value="MS-125">MS-125 (.208)</option>
          <option value="MS-137">MS-137 (.217)</option>
          <option value="MS-146">MS-146 (.227)</option>
          <option value="MS-162">MS-162 (.241)</option>
          <option value="custom" data-t="opt_custom">Mesure custom</option>
        </select>
      </div>
      <div id="customSizingDiv" style="display:none;">
        <label data-t="calc_custom_label">Largeur mesurée (pouces)</label>
        <input type="number" id="customSizingWidth" step="0.001" min="0.1" max="0.3" placeholder=".227">
      </div>
      <div>
        <label data-t="calc_type_label">Type de pointe</label>
        <select id="pinType">
          <option value="any" data-t="opt_all_types">Tous types</option>
          <option value="balance">Balance</option>
          <option value="enfoncement" data-t="opt_enfoncement">Enfoncement</option>
        </select>
      </div>
      <button onclick="calculate()" data-t="btn_calculate">Calculer</button>
    </div>
    <div id="calcResults"></div>
  </div>

  <!-- SAISIE -->
  <div id="entry" class="panel">
    <h2 style="margin-bottom:16px; color:#e94560;" data-t="entry_title">Nouvelle entrée</h2>

    <!-- Client / Piano (commun) -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
      <div class="form-group">
        <label data-t="lbl_client">Client</label>
        <input type="text" id="f_client" data-ph="ph_client">
      </div>
      <div class="form-group">
        <label data-t="lbl_piano">Piano (nom/modèle)</label>
        <input type="text" id="f_piano" data-ph="ph_piano">
      </div>
    </div>

    <!-- Deux sections côte à côte -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">

      <!-- BALANCE -->
      <div style="background:#16213e; border-radius:8px; padding:16px; border:1px solid #0f3460;">
        <h3 style="color:#4ecca3; margin-bottom:12px; font-size:15px;">Balance</h3>
        <div style="display:grid; gap:12px;">
          <div class="form-group">
            <label data-t="lbl_pin_size">Taille pointe (pouces)</label>
            <input type="number" id="f_bal_pinSize" step="0.001" min="0.05" max="0.25" placeholder=".125">
          </div>
          <div class="form-group">
            <label data-t="lbl_sizing_used">Sizing utilisé</label>
            <select id="f_bal_sizing">
              <option value="" data-t="opt_none_custom">-- Aucun / Custom --</option>
              <option value="MS-125">MS-125 (.208)</option>
              <option value="MS-137">MS-137 (.217)</option>
              <option value="MS-146">MS-146 (.227)</option>
              <option value="MS-162">MS-162 (.241)</option>
            </select>
          </div>
          <div class="form-group">
            <label data-t="lbl_sizing_width">Largeur sizing mesurée</label>
            <input type="number" id="f_bal_sizingWidth" step="0.001" placeholder=".227">
          </div>
          <div class="form-group">
            <label data-t="lbl_felt_used">Feutre utilisé (mm)</label>
            <select id="f_bal_felt"><option value="" data-t="opt_choose">-- Choisir --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_inter_caul">Cale intermédiaire</label>
            <select id="f_bal_interCaul"><option value="" data-t="opt_none">-- Aucune --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_final_caul">Cale finale</label>
            <select id="f_bal_finalCaul"><option value="" data-t="opt_none">-- Aucune --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_verdict">Verdict</label>
            <select id="f_bal_verdict">
              <option value="" data-t="opt_not_tested">-- Non testé --</option>
              <option value="parfait" data-t="opt_parfait">Parfait</option>
              <option value="ok">OK</option>
              <option value="trop_lache" data-t="opt_lache">Trop lâche</option>
              <option value="trop_serre" data-t="opt_serre">Trop serré</option>
            </select>
          </div>
          <div class="form-group">
            <label data-t="lbl_notes">Notes</label>
            <textarea id="f_bal_notes" data-ph="ph_notes_bal" style="min-height:40px;"></textarea>
          </div>
        </div>
      </div>

      <!-- ENFONCEMENT -->
      <div style="background:#16213e; border-radius:8px; padding:16px; border:1px solid #0f3460;">
        <h3 style="color:#e94560; margin-bottom:12px; font-size:15px;" data-t="lbl_enfoncement">Enfoncement</h3>
        <div style="display:grid; gap:12px;">
          <div class="form-group">
            <label data-t="lbl_pin_size">Taille pointe (pouces)</label>
            <input type="number" id="f_enf_pinSize" step="0.001" min="0.05" max="0.25" placeholder=".146">
          </div>
          <div class="form-group">
            <label data-t="lbl_sizing_used">Sizing utilisé</label>
            <select id="f_enf_sizing">
              <option value="" data-t="opt_none_custom">-- Aucun / Custom --</option>
              <option value="MS-125">MS-125 (.208)</option>
              <option value="MS-137">MS-137 (.217)</option>
              <option value="MS-146">MS-146 (.227)</option>
              <option value="MS-162">MS-162 (.241)</option>
            </select>
          </div>
          <div class="form-group">
            <label data-t="lbl_sizing_width">Largeur sizing mesurée</label>
            <input type="number" id="f_enf_sizingWidth" step="0.001" placeholder=".227">
          </div>
          <div class="form-group">
            <label data-t="lbl_felt_used">Feutre utilisé (mm)</label>
            <select id="f_enf_felt"><option value="" data-t="opt_choose">-- Choisir --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_inter_caul">Cale intermédiaire</label>
            <select id="f_enf_interCaul"><option value="" data-t="opt_none">-- Aucune --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_final_caul">Cale finale</label>
            <select id="f_enf_finalCaul"><option value="" data-t="opt_none">-- Aucune --</option></select>
          </div>
          <div class="form-group">
            <label data-t="lbl_verdict">Verdict</label>
            <select id="f_enf_verdict">
              <option value="" data-t="opt_not_tested">-- Non testé --</option>
              <option value="parfait" data-t="opt_parfait">Parfait</option>
              <option value="ok">OK</option>
              <option value="trop_lache" data-t="opt_lache">Trop lâche</option>
              <option value="trop_serre" data-t="opt_serre">Trop serré</option>
            </select>
          </div>
          <div class="form-group">
            <label data-t="lbl_notes">Notes</label>
            <textarea id="f_enf_notes" data-ph="ph_notes_enf" style="min-height:40px;"></textarea>
          </div>
        </div>
      </div>

    </div>

    <div class="form-actions" style="margin-top:16px;">
      <button class="btn btn-primary" onclick="addEntry()" data-t="btn_add">Ajouter</button>
      <button class="btn btn-secondary" onclick="clearForm()" data-t="btn_clear">Effacer</button>
    </div>
  </div>

  <!-- HISTORIQUE -->
  <div id="data" class="panel">
    <div class="table-actions">
      <select id="filterVerdict" onchange="renderTable()">
        <option value="all" data-t="filter_all">Tous les verdicts</option>
        <option value="parfait" data-t="opt_parfait">Parfait</option>
        <option value="ok">OK</option>
        <option value="trop_lache" data-t="opt_lache">Trop lâche</option>
        <option value="trop_serre" data-t="opt_serre">Trop serré</option>
      </select>
      <input type="text" id="filterPiano" data-ph="ph_filter" oninput="renderTable()">
      <label style="color:#888; font-size:13px; display:flex; align-items:center; gap:4px;">
        <input type="checkbox" id="groupView" onchange="renderTable()" checked> <span data-t="lbl_group">Grouper par piano</span>
      </label>
      <button class="btn btn-secondary" onclick="exportData()">Export JSON</button>
      <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      <span id="dataCount" style="color:#888; font-size:13px; margin-left:auto;"></span>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Outlier</th>
            <th data-t="th_client_piano">Client / Piano</th>
            <th>Type</th>
            <th data-t="th_pin">Pointe</th>
            <th>Sizing</th>
            <th data-t="th_width">Larg.</th>
            <th style="background:#e94560; color:#fff; font-size:14px;" data-t="th_felt">★ Feutre</th>
            <th>Inter</th>
            <th data-t="th_final">Finale</th>
            <th data-t="th_verdict">Verdict</th>
            <th data-t="th_notes">Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </div>

  <!-- INVENTAIRE -->
  <div id="stock" class="panel">
    <h2 style="margin-bottom:16px; color:#e94560;" data-t="stock_title">Inventaire des cales</h2>
    <div id="stockGrid" class="stock-grid"></div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
// ============================================================
// i18n — BILINGUAL SUPPORT (FR/EN)
// ============================================================
let currentLang = localStorage.getItem('felt-calc-lang') || 'fr';

const TRANSLATIONS = {
  // Header
  header_title:       { fr: 'Calculateur Feutrage', en: 'Hammer Felt Calculator' },
  header_subtitle:    { fr: 'Marteaux de piano - Cales & Feutres', en: 'Piano Hammers - Cauls & Felts' },

  // Tabs
  tab_calc:           { fr: 'Calculateur', en: 'Calculator' },
  tab_entry:          { fr: 'Saisie', en: 'Entry' },
  tab_history:        { fr: 'Historique', en: 'History' },
  tab_stock:          { fr: 'Inventaire', en: 'Inventory' },

  // Calculator inputs
  calc_pin_label:     { fr: 'Taille de la pointe (pouces)', en: 'Pin size (inches)' },
  calc_sizing_label:  { fr: 'Sizing / Mortaise', en: 'Sizing / Mortise' },
  calc_custom_label:  { fr: 'Largeur mesurée (pouces)', en: 'Measured width (inches)' },
  calc_type_label:    { fr: 'Type de pointe', en: 'Pin type' },
  btn_calculate:      { fr: 'Calculer', en: 'Calculate' },

  // Dropdowns — common
  opt_choose:         { fr: '-- Choisir --', en: '-- Select --' },
  opt_custom:         { fr: 'Mesure custom', en: 'Custom measurement' },
  opt_all_types:      { fr: 'Tous types', en: 'All types' },
  opt_enfoncement:    { fr: 'Enfoncement', en: 'Front pin' },
  opt_none:           { fr: '-- Aucune --', en: '-- None --' },
  opt_none_custom:    { fr: '-- Aucun / Custom --', en: '-- None / Custom --' },
  opt_not_tested:     { fr: '-- Non testé --', en: '-- Not tested --' },
  opt_parfait:        { fr: 'Parfait', en: 'Perfect' },
  opt_lache:          { fr: 'Trop lâche', en: 'Too loose' },
  opt_serre:          { fr: 'Trop serré', en: 'Too tight' },

  // Recommendation tiles
  tile_felt:          { fr: '★ Feutre recommandé', en: '★ Recommended Felt' },
  tile_sizing:        { fr: 'Sizing', en: 'Sizing' },
  tile_inter:         { fr: 'Cale Inter', en: 'Inter Caul' },
  tile_final:         { fr: 'Cale Finale', en: 'Final Caul' },
  conf_high:          { fr: 'Confiance élevée', en: 'High confidence' },
  conf_medium:        { fr: 'Confiance moyenne', en: 'Medium confidence' },
  conf_low_formula:   { fr: 'Formule directe', en: 'Direct formula' },
  conf_low_theo:      { fr: 'Estimation théorique', en: 'Theoretical estimate' },
  conf_none:          { fr: 'Entrez la largeur de mortaise', en: 'Enter mortise width' },
  src_formula:        { fr: 'Formule directe', en: 'Direct formula' },
  src_theo:           { fr: 'Théorique (Spurlock)', en: 'Theoretical (Spurlock)' },
  src_hist:           { fr: 'Historique', en: 'History' },
  src_formula_short:  { fr: 'formule', en: 'formula' },

  // Bounds bar
  bounds_loose:       { fr: '▼ Trop lâche à ≤', en: '▼ Too loose at ≤' },
  bounds_rec:         { fr: '● Recommandé :', en: '● Recommended:' },
  bounds_tight:       { fr: '▲ Trop serré à ≥', en: '▲ Too tight at ≥' },

  // Range bar
  range_title:        { fr: 'Plage de feutres testés', en: 'Tested felt range' },

  // History detail
  hist_toggle:        { fr: 'entrée(s) historique(s) correspondante(s)', en: 'matching history entry(ies)' },
  hist_header:        { fr: 'Données historiques proches', en: 'Close historical data' },

  // Feedback form
  fb_title:           { fr: 'Résultat réel de la job', en: 'Actual job result' },
  lbl_client:         { fr: 'Client', en: 'Client' },
  lbl_piano:          { fr: 'Piano (nom/modèle)', en: 'Piano (name/model)' },
  lbl_pin_size:       { fr: 'Taille pointe (pouces)', en: 'Pin size (inches)' },
  lbl_sizing_used:    { fr: 'Sizing utilisé', en: 'Sizing used' },
  lbl_sizing_width:   { fr: 'Largeur sizing mesurée', en: 'Measured sizing width' },
  lbl_felt_used:      { fr: 'Feutre utilisé (mm)', en: 'Felt used (mm)' },
  lbl_inter_caul:     { fr: 'Cale intermédiaire', en: 'Intermediate caul' },
  lbl_final_caul:     { fr: 'Cale finale', en: 'Final caul' },
  lbl_verdict:        { fr: 'Verdict', en: 'Verdict' },
  lbl_notes:          { fr: 'Notes', en: 'Notes' },
  lbl_enfoncement:    { fr: 'Enfoncement', en: 'Front pin' },
  lbl_type:           { fr: 'Type', en: 'Type' },
  lbl_pin:            { fr: 'Pointe', en: 'Pin' },
  lbl_felt_star:      { fr: '★ Feutre utilisé', en: '★ Felt used' },
  lbl_sizing_w:       { fr: 'Larg. sizing', en: 'Sizing width' },
  btn_save_feedback:  { fr: 'Sauvegarder dans l\'historique', en: 'Save to history' },
  fb_observations:    { fr: 'Observations...', en: 'Observations...' },

  // Entry form
  entry_title:        { fr: 'Nouvelle entrée', en: 'New entry' },
  btn_add:            { fr: 'Ajouter', en: 'Add' },
  btn_clear:          { fr: 'Effacer', en: 'Clear' },
  ph_client:          { fr: 'Ex: Lamontagne', en: 'e.g. Smith' },
  ph_piano:           { fr: 'Ex: Steinway D', en: 'e.g. Steinway D' },
  ph_notes_bal:       { fr: 'Observations balance...', en: 'Balance observations...' },
  ph_notes_enf:       { fr: 'Observations enfoncement...', en: 'Front pin observations...' },

  // History table
  filter_all:         { fr: 'Tous les verdicts', en: 'All verdicts' },
  ph_filter:          { fr: 'Filtrer par client ou piano...', en: 'Filter by client or piano...' },
  lbl_group:          { fr: 'Grouper par piano', en: 'Group by piano' },
  th_client_piano:    { fr: 'Client / Piano', en: 'Client / Piano' },
  th_pin:             { fr: 'Pointe', en: 'Pin' },
  th_width:           { fr: 'Larg.', en: 'Width' },
  th_felt:            { fr: '★ Feutre', en: '★ Felt' },
  th_final:           { fr: 'Finale', en: 'Final' },
  th_verdict:         { fr: 'Verdict', en: 'Verdict' },
  th_notes:           { fr: 'Notes', en: 'Notes' },

  // Stock
  stock_title:        { fr: 'Inventaire des cales', en: 'Caul Inventory' },

  // Verdicts (for badges & rendering)
  v_parfait:          { fr: 'Parfait', en: 'Perfect' },
  v_ok:               { fr: 'OK', en: 'OK' },
  v_lache:            { fr: 'Trop lâche', en: 'Too loose' },
  v_serre:            { fr: 'Trop serré', en: 'Too tight' },
  v_bal:              { fr: 'Bal.', en: 'Bal.' },
  v_enf:              { fr: 'Enf.', en: 'Front' },

  // Toasts
  toast_invalid_pin:  { fr: 'Entrez une taille de pointe valide (.050 - .250)', en: 'Enter a valid pin size (.050 - .250)' },
  toast_enter_piano:  { fr: 'Entrez le nom du piano', en: 'Enter the piano name' },
  toast_choose_verdict: { fr: 'Choisissez un verdict', en: 'Choose a verdict' },
  toast_choose_felt:  { fr: 'Choisissez le feutre utilisé', en: 'Choose the felt used' },
  toast_saved:        { fr: 'Entrée sauvegardée ! La recommandation va s\'améliorer.', en: 'Entry saved! Recommendation will improve.' },
  toast_fill_side:    { fr: 'Remplissez au moins un côté (balance ou enfoncement)', en: 'Fill at least one side (balance or front pin)' },
  toast_added:        { fr: 'entrée(s) ajoutée(s) !', en: 'entry(ies) added!' },
  toast_deleted:      { fr: 'Entrée supprimée', en: 'Entry deleted' },
  toast_modify:       { fr: 'Modifier puis cliquer Ajouter', en: 'Edit then click Add' },
  toast_imported:     { fr: 'Importé :', en: 'Imported:' },
  toast_import_err:   { fr: 'Erreur d\'import :', en: 'Import error:' },
  confirm_delete:     { fr: 'Supprimer cette entrée ?', en: 'Delete this entry?' },

  // Misc
  entries:            { fr: 'entrées', en: 'entries' },
  jobs:               { fr: 'jobs', en: 'jobs' },
  or:                 { fr: 'ou', en: 'or' },
  type_bal:           { fr: '(bal.)', en: '(bal.)' },
  type_enf:           { fr: '(enf.)', en: '(front)' },
};

function t(key) {
  const entry = TRANSLATIONS[key];
  if (!entry) return key;
  return entry[currentLang] || entry.fr || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('felt-calc-lang', lang);
  document.getElementById('langFR').classList.toggle('active', lang === 'fr');
  document.getElementById('langEN').classList.toggle('active', lang === 'en');
  document.documentElement.lang = lang;
  applyTranslations();
}

function applyTranslations() {
  // Update all elements with data-t attribute (text content)
  document.querySelectorAll('[data-t]').forEach(el => {
    el.textContent = t(el.getAttribute('data-t'));
  });
  // Update all elements with data-ph attribute (placeholder)
  document.querySelectorAll('[data-ph]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-ph'));
  });
  // Re-render dynamic content if visible
  const calcResults = document.getElementById('calcResults');
  if (calcResults && calcResults.innerHTML) {
    // Re-run calculation if results are showing
    const pin = parseFloat(document.getElementById('pinSize').value);
    if (pin) calculate();
  }
  renderTable();
  renderStock();
}

// ============================================================
// DATA: Cales inventory
// ============================================================
const DEFAULT_CAULS = [
  { id: '#1', name: '#1 Intermediate', thickness: 0.185, qty: 90 },
  { id: '#2', name: '#2 Final', thickness: 0.149, qty: 180 },
  { id: '#3', name: '#3 Intermediate', thickness: 0.200, qty: 90 },
  { id: '#4', name: '#4 Intermediate', thickness: 0.163, qty: 90 },
  { id: '#5', name: '#5 Final', thickness: 0.128, qty: 90 },
  { id: '#6', name: '#6 Final', thickness: 0.090, qty: 90 },
  { id: '#7', name: '#7 Intermediate', thickness: 0.174, qty: 90 },
  { id: '#8', name: '#8 Final', thickness: 0.140, qty: 90 },
  { id: '#9', name: '#9 Final', thickness: 0.134, qty: 90 },
  { id: '#10', name: '#10 Final', thickness: 0.133, qty: 90 },
  { id: '#11', name: '#11 Final', thickness: 0.159, qty: 90 },
  { id: '#12', name: '#12 Final', thickness: 0.131, qty: 90 },
  { id: 'MS-125', name: 'MS-125 Sizing', thickness: 0.208, qty: 90 },
  { id: 'MS-137', name: 'MS-137 Sizing', thickness: 0.217, qty: 90 },
  { id: 'MS-146', name: 'MS-146 Sizing', thickness: 0.227, qty: 180 },
  { id: 'MS-162', name: 'MS-162 Sizing', thickness: 0.241, qty: 90 },
  { id: 'DS-125', name: 'DS-125 Double Shoulder', thickness: 0.128, qty: 90 },
  { id: 'DS-162', name: 'DS-162 Double Shoulder', thickness: 0.163, qty: 90 },
  { id: 'Mark-rouge', name: 'Mark bout rouge (sizing)', thickness: 0.175, qty: 0 },
  { id: 'Mark-transp', name: 'Mark transparentes (sizing)', thickness: 0.216, qty: 0 },
];

// Spurlock recommendations: pin size -> { inter, final, finalAlt, sizing }
const SPURLOCK = {
  0.087: { inter: '#5', final: '#6', finalAlt: null, sizing: null },
  0.125: { inter: '#4', final: '#5', finalAlt: 'DS-125', sizing: 'MS-125' },
  0.129: { inter: '#4', final: '#12', finalAlt: 'DS-129', sizing: 'MS-125' },
  0.131: { inter: '#4', final: '#10', finalAlt: 'DS-131', sizing: 'MS-125' },
  0.133: { inter: '#4', final: '#9', finalAlt: 'DS-133', sizing: 'MS-125' },
  0.137: { inter: '#7', final: '#8', finalAlt: 'DS-137', sizing: 'MS-137' },
  0.146: { inter: '#1', final: '#2', finalAlt: 'DS-146', sizing: 'MS-146' },
  0.152: { inter: '#1', final: '#11', finalAlt: null, sizing: 'MS-146' },
  0.162: { inter: '#3', final: '#4', finalAlt: 'DS-162', sizing: 'MS-162' },
};

// Historical data (pre-loaded)
const DEFAULT_HISTORY = [
  // CSV ligne 2: Steigerman — col C(bal)=.125, sizing=.200, largSizing=.200, feutre=0.9, verdict=trop lâche
  { id: 1, piano: 'Steigerman Ambiance', pinType: 'balance', pinSize: 0.125, sizing: '.200', sizingWidth: 0.200, felt: 0.9, interCaul: '', finalCaul: '', verdict: 'trop_lache', notes: '', outlier: false },
  // CSV ligne 3: Steigerman — col B(enf)=.132, sizing=.216, largSizing=.216, feutre=0.9, verdict=trop lâche
  { id: 2, piano: 'Steigerman Ambiance', pinType: 'enfoncement', pinSize: 0.132, sizing: '.216', sizingWidth: 0.216, felt: 0.9, interCaul: '', finalCaul: '', verdict: 'trop_lache', notes: '', outlier: false },
  // CSV ligne 4: (pas de piano) — col B(enf)=.134, largSizing=.135, feutre=0.9, pas de verdict
  { id: 25, piano: 'Steigerman Ambiance', pinType: 'enfoncement', pinSize: 0.134, sizing: '', sizingWidth: 0.135, felt: 0.9, interCaul: '', finalCaul: '', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 5: Nu1X — col B(enf)=.124, sizing=ms-137, largSizing=.217, feutre=1.2, inter=#7, final=#8
  { id: 3, piano: 'Nu1X', pinType: 'enfoncement', pinSize: 0.124, sizing: 'MS-137', sizingWidth: 0.217, felt: 1.2, interCaul: '#7', finalCaul: '#8', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 6: Nu1X — col C(bal)=.138, sizing=ms-146, largSizing=.227, feutre=1.3, verdict=serré, inter=ms-125, final=#7
  { id: 4, piano: 'Nu1X', pinType: 'balance', pinSize: 0.138, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.3, interCaul: 'MS-125', finalCaul: '#7', verdict: 'trop_serre', notes: '', outlier: false },
  // CSV ligne 7: Karn — col C(bal)=.140, sizing=ms-146, largSizing=.227, feutre=1.2, inter=#1, final=#2
  { id: 5, piano: 'Karn', pinType: 'balance', pinSize: 0.140, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.2, interCaul: '#1', finalCaul: '#2', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 8: Karn — col B(enf)=.140, sizing=ms-145, largSizing=.227, feutre=1.1, inter=#1, final=#11
  { id: 6, piano: 'Karn', pinType: 'enfoncement', pinSize: 0.140, sizing: 'MS-145', sizingWidth: 0.227, felt: 1.1, interCaul: '#1', finalCaul: '#11', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 9: Anh Triet — col B(enf)=.146, sizing=ms-146, largSizing=.227, feutre=1.2, inter=#1, final=#2
  { id: 7, piano: 'Anh Triet', pinType: 'enfoncement', pinSize: 0.146, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.2, interCaul: '#1', finalCaul: '#2', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 10: Anh Triet — col C(bal)=.146, sizing=ms-146, largSizing=.227, feutre=1.3
  { id: 8, piano: 'Anh Triet', pinType: 'balance', pinSize: 0.146, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.3, interCaul: '', finalCaul: '', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 11: Bosen — col B(enf)=.131, col D(mortaise)=.194, sizing=.200, largSizing=.200, feutre=1.3
  { id: 9, piano: 'Bosendorfer', pinType: 'enfoncement', pinSize: 0.131, sizing: '.200', sizingWidth: 0.200, felt: 1.3, interCaul: '', finalCaul: '', verdict: 'ok', notes: 'mortaise=.194', outlier: false },
  // CSV ligne 12: Bosen — col C(bal)=.131, col D(mortaise)=.208, sizing=.209, largSizing=.209, feutre=1.3, final=#2
  { id: 10, piano: 'Bosendorfer', pinType: 'balance', pinSize: 0.131, sizing: '.209', sizingWidth: 0.209, felt: 1.3, interCaul: '', finalCaul: '#2', verdict: 'ok', notes: 'mortaise=.208', outlier: false },
  // CSV ligne 13: Steinway D — col B(enf)=.150, sizing=.217, largSizing=.217, feutre=1.4, inter=#2, final=#11
  { id: 11, piano: 'Steinway D', pinType: 'enfoncement', pinSize: 0.150, sizing: '.217', sizingWidth: 0.217, felt: 1.4, interCaul: '#2', finalCaul: '#11', verdict: 'ok', notes: 'mortaises plus grandes que .242', outlier: false },
  // CSV ligne 14: Steinway D — col C(bal)=.160, sizing=.241, largSizing=.241, feutre=1.3, final=#4
  { id: 12, piano: 'Steinway D', pinType: 'balance', pinSize: 0.160, sizing: '.241', sizingWidth: 0.241, felt: 1.3, interCaul: '', finalCaul: '#4', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 15: Steinway D 240 — col B(enf)=.150, feutre=0, final=#11
  { id: 29, piano: 'Steinway D 240', pinType: 'enfoncement', pinSize: 0.150, sizing: '', sizingWidth: 0, felt: 0, interCaul: '', finalCaul: '#11', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 16: Steinway D 240 — col C(bal)=.160, feutre=1.3, final=#4
  { id: 30, piano: 'Steinway D 240', pinType: 'balance', pinSize: 0.160, sizing: '', sizingWidth: 0, felt: 1.3, interCaul: '', finalCaul: '#4', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 17: Lamontagne — col C(bal)=.137, sizing=ms-146, largSizing=.227, feutre=1.2, inter=#1, final=#2
  { id: 13, piano: 'Lamontagne', pinType: 'balance', pinSize: 0.137, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.2, interCaul: '#1', finalCaul: '#2', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 18: Lamontagne — col B(enf)=.133, sizing=ms-125, largSizing=.209, feutre=1.1, inter=#4, final=#9
  { id: 14, piano: 'Lamontagne', pinType: 'enfoncement', pinSize: 0.133, sizing: 'MS-125', sizingWidth: 0.209, felt: 1.1, interCaul: '#4', finalCaul: '#9', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 19: Steinway — col B(enf)=.146, sizing=ms-146, largSizing=.227, feutre=1.3, verdict=parfait, inter=#1, final=#2
  { id: 15, piano: 'Steinway', pinType: 'enfoncement', pinSize: 0.146, sizing: 'MS-146', sizingWidth: 0.227, felt: 1.3, interCaul: '#1', finalCaul: '#2', verdict: 'parfait', notes: '', outlier: false },
  // CSV ligne 20: Steinway — col C(bal)=.162, sizing=ms-162, largSizing=.241, feutre=1.3, verdict=parfait, inter=#3, final=#4
  { id: 16, piano: 'Steinway', pinType: 'balance', pinSize: 0.162, sizing: 'MS-162', sizingWidth: 0.241, felt: 1.3, interCaul: '#3', finalCaul: '#4', verdict: 'parfait', notes: '', outlier: false },
  // CSV ligne 21: K-3 — col B(enf)=.125, feutre=1.1, verdict=serré, inter=#4
  { id: 17, piano: 'K-3', pinType: 'enfoncement', pinSize: 0.125, sizing: '', sizingWidth: 0, felt: 1.1, interCaul: '#4', finalCaul: '', verdict: 'trop_serre', notes: '', outlier: false },
  // CSV ligne 22: K-3 — col C(bal)=.125, feutre=1.3, verdict=serré, inter=ds-125
  { id: 18, piano: 'K-3', pinType: 'balance', pinSize: 0.125, sizing: '', sizingWidth: 0, felt: 1.3, interCaul: 'DS-125', finalCaul: '', verdict: 'trop_serre', notes: '', outlier: false },
  // CSV ligne 23: Kg-2 — col B(enf)=.132, sizing=ms137, largSizing=.217, feutre=1.2, verdict=ok, inter=#1, final=#2
  { id: 19, piano: 'Kawai Kg-2', pinType: 'enfoncement', pinSize: 0.132, sizing: 'MS-137', sizingWidth: 0.217, felt: 1.2, interCaul: '#1', finalCaul: '#2', verdict: 'ok', notes: '', outlier: false },
  // CSV ligne 24: Kg-2 — col C(bal)=.145, largSizing=.209, feutre=1.0, verdict=parfait, inter=#1, final=#2
  { id: 20, piano: 'Kawai Kg-2', pinType: 'balance', pinSize: 0.145, sizing: '', sizingWidth: 0.209, felt: 1.0, interCaul: '#1', finalCaul: '#2', verdict: 'parfait', notes: '', outlier: false },
  // CSV ligne 25: Steinway D Pierre-Mercure — col B(enf)=.130, sizing=ms126, largSizing=.209
  { id: 21, piano: 'Steinway D Pierre-Mercure', pinType: 'enfoncement', pinSize: 0.130, sizing: 'MS-126', sizingWidth: 0.209, felt: 0, interCaul: '', finalCaul: '', verdict: 'ok', notes: 'Données partielles', outlier: true },
  // CSV ligne 26: Steinway D Pierre-Mercure — col C(bal)=.140, sizing=ms-146, largSizing=.227
  { id: 22, piano: 'Steinway D Pierre-Mercure', pinType: 'balance', pinSize: 0.140, sizing: 'MS-146', sizingWidth: 0.227, felt: 0, interCaul: '', finalCaul: '', verdict: 'ok', notes: 'Données partielles', outlier: true },
];

// ============================================================
// STATE
// ============================================================
let history = [];
let cauls = [];
let nextId = 100;

function loadData() {
  const saved = localStorage.getItem('felt-calc-history');
  if (saved) {
    history = JSON.parse(saved);
    nextId = Math.max(...history.map(h => h.id), 99) + 1;
  } else {
    history = [...DEFAULT_HISTORY];
    nextId = 100;
  }
  const savedCauls = localStorage.getItem('felt-calc-cauls');
  if (savedCauls) {
    cauls = JSON.parse(savedCauls);
  } else {
    cauls = DEFAULT_CAULS.map(c => ({...c}));
  }
}

function saveData() {
  localStorage.setItem('felt-calc-history', JSON.stringify(history));
  localStorage.setItem('felt-calc-cauls', JSON.stringify(cauls));
}

// ============================================================
// TABS
// ============================================================
function showTab(id) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    const panels = ['calc', 'entry', 'data', 'stock'];
    t.classList.toggle('active', panels[i] === id);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === id));
  if (id === 'data') renderTable();
  if (id === 'stock') renderStock();
}

// ============================================================
// CALCULATOR — Unified Recommendations
// ============================================================
const TOLERANCE = 0.012;

function getClosestSpurlock(pin) {
  const sizes = Object.keys(SPURLOCK).map(Number).sort((a, b) => a - b);
  let closest = sizes[0];
  for (const s of sizes) { if (Math.abs(pin - s) < Math.abs(pin - closest)) closest = s; }
  return { pinSize: closest, ...SPURLOCK[closest] };
}

function caulLabel(id) {
  const c = DEFAULT_CAULS.find(c => c.id === id);
  return c ? `${id} (.${c.thickness.toFixed(3).slice(2)}")` : id || '—';
}

function caulLabelShort(id) {
  return id || '—';
}

function computeRecommendations(pin, type, mortiseWidth) {
  // Filter historical data: match pin size, optionally also match mortise width
  const PIN_TOL = 0.012;
  const MORTISE_TOL = 0.008;

  const allRelevant = history.filter(h =>
    !h.outlier && h.felt > 0 &&
    Math.abs(h.pinSize - pin) <= PIN_TOL &&
    (type === 'any' || h.pinType === type)
  );

  // If mortise width provided, prefer entries with matching mortise; fallback to all
  let relevant;
  if (mortiseWidth > 0) {
    const withMortise = allRelevant.filter(h => h.sizingWidth > 0 && Math.abs(h.sizingWidth - mortiseWidth) <= MORTISE_TOL);
    relevant = withMortise.length > 0 ? withMortise : allRelevant;
  } else {
    relevant = allRelevant;
  }

  const parfait = relevant.filter(h => h.verdict === 'parfait');
  const ok = relevant.filter(h => h.verdict === 'ok');
  const good = [...parfait, ...ok];
  const lache = relevant.filter(h => h.verdict === 'trop_lache');
  const serre = relevant.filter(h => h.verdict === 'trop_serre');

  const spurlock = getClosestSpurlock(pin);

  // --- FELT recommendation ---
  let felt = { value: null, source: '', confidence: 'none' };

  // Theoretical: direct formula if mortise width is known
  let theoretical = null;
  if (mortiseWidth > 0) {
    // Direct calculation: (mortise - pin) / 2, converted to mm
    theoretical = roundToNearest005((mortiseWidth - pin) / 2 * 25.4);
    if (theoretical <= 0) theoretical = null; // invalid
  } else if (spurlock.sizing) {
    // Fallback: use Spurlock sizing caul thickness
    const sizingCaul = DEFAULT_CAULS.find(c => c.id === spurlock.sizing);
    if (sizingCaul) {
      theoretical = roundToNearest005((sizingCaul.thickness - pin) / 2 * 25.4);
    }
  }

  if (parfait.length > 0) {
    const weightedSum = parfait.reduce((s, h) => s + h.felt * 3, 0) + ok.reduce((s, h) => s + h.felt, 0);
    const weightedCount = parfait.length * 3 + ok.length;
    const histAvg = weightedSum / weightedCount;
    felt.value = roundToNearest005(histAvg);
    felt.source = `${parfait.length} parfait, ${ok.length} ok`;
    felt.confidence = 'high';
  } else if (ok.length > 0) {
    const histAvg = ok.reduce((s, h) => s + h.felt, 0) / ok.length;
    if (theoretical) {
      felt.value = roundToNearest005(histAvg * 0.8 + theoretical * 0.2);
      felt.source = `${ok.length} ok + formule`;
    } else {
      felt.value = roundToNearest005(histAvg);
      felt.source = `${ok.length} ok`;
    }
    felt.confidence = 'medium';
  } else if (theoretical) {
    felt.value = theoretical;
    felt.source = mortiseWidth > 0 ? 'Formule directe' : 'Théorique (Spurlock)';
    felt.confidence = mortiseWidth > 0 ? 'medium' : 'low';
  }

  // Bounds
  felt.maxLache = lache.length > 0 ? Math.max(...lache.map(h => h.felt)) : null;
  felt.minSerre = serre.length > 0 ? Math.min(...serre.map(h => h.felt)) : null;

  // --- SIZING recommendation ---
  let sizing = { value: null, label: '', source: '' };
  // Check history: most used sizing with good results
  const goodWithSizing = good.filter(h => h.sizing && h.sizing.startsWith('MS-'));
  if (goodWithSizing.length > 0) {
    const counts = {};
    goodWithSizing.forEach(h => { counts[h.sizing] = (counts[h.sizing] || 0) + (h.verdict === 'parfait' ? 3 : 1); });
    const best = Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
    sizing.value = best;
    sizing.label = caulLabel(best);
    sizing.source = `Historique (${goodWithSizing.length} jobs)`;
  } else if (spurlock.sizing) {
    sizing.value = spurlock.sizing;
    sizing.label = caulLabel(spurlock.sizing);
    sizing.source = 'Spurlock';
  }

  // --- INTER CAUL recommendation ---
  let inter = { value: null, label: '', source: '' };
  const goodWithInter = good.filter(h => h.interCaul && h.interCaul.startsWith('#'));
  if (goodWithInter.length > 0) {
    const counts = {};
    goodWithInter.forEach(h => { counts[h.interCaul] = (counts[h.interCaul] || 0) + (h.verdict === 'parfait' ? 3 : 1); });
    const best = Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
    inter.value = best;
    inter.label = caulLabel(best);
    inter.source = `Historique (${goodWithInter.length} jobs)`;
  } else {
    inter.value = spurlock.inter;
    inter.label = caulLabel(spurlock.inter);
    inter.source = 'Spurlock';
  }

  // --- FINAL CAUL recommendation ---
  let final_ = { value: null, label: '', source: '' };
  const goodWithFinal = good.filter(h => h.finalCaul && (h.finalCaul.startsWith('#') || h.finalCaul.startsWith('DS-')));
  if (goodWithFinal.length > 0) {
    const counts = {};
    goodWithFinal.forEach(h => { counts[h.finalCaul] = (counts[h.finalCaul] || 0) + (h.verdict === 'parfait' ? 3 : 1); });
    const best = Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
    final_.value = best;
    final_.label = caulLabel(best);
    final_.source = `Historique (${goodWithFinal.length} jobs)`;
  } else {
    final_.value = spurlock.final;
    final_.label = caulLabel(spurlock.final);
    final_.source = 'Spurlock';
    if (spurlock.finalAlt) {
      final_.label += ` ${t('or')} ${caulLabelShort(spurlock.finalAlt)}`;
    }
  }

  return { felt, sizing, inter, final: final_, relevant, allRelevant, spurlock, theoretical, mortiseWidth };
}

function onSizingSelect() {
  const sel = document.getElementById('sizingSelect').value;
  const customDiv = document.getElementById('customSizingDiv');
  customDiv.style.display = sel === 'custom' ? 'block' : 'none';
}

function getMortiseWidth() {
  const sel = document.getElementById('sizingSelect').value;
  if (sel === 'custom') {
    return parseFloat(document.getElementById('customSizingWidth').value) || 0;
  } else if (sel) {
    const caul = DEFAULT_CAULS.find(c => c.id === sel);
    return caul ? caul.thickness : 0;
  }
  return 0;
}

function calculate() {
  const pin = parseFloat(document.getElementById('pinSize').value);
  const type = document.getElementById('pinType').value;
  const mortiseWidth = getMortiseWidth();
  if (!pin || pin < 0.05 || pin > 0.25) {
    showToast(t('toast_invalid_pin'));
    return;
  }

  const recs = computeRecommendations(pin, type, mortiseWidth);
  const results = document.getElementById('calcResults');
  let html = '';

  // 1. Four recommendation tiles
  html += renderTiles(pin, type, recs);

  // 2. Bounds bar
  html += renderBoundsBar(recs.felt);

  // 3. Range bar (compact)
  html += renderRangeBar(pin, type);

  // 4. History matches (collapsible)
  html += renderHistoryDetail(recs.relevant);

  // 5. Feedback form
  html += renderFeedbackForm(pin, type, recs);

  results.innerHTML = html;

  // Populate feedback dropdowns
  populateFeedbackDropdowns(recs);
}

function renderTiles(pin, type, recs) {
  const { felt, sizing, inter, final: final_ } = recs;
  const typeLabel = type === 'any' ? '' : type === 'balance' ? ` ${t('type_bal')}` : ` ${t('type_enf')}`;

  let html = `<div class="rec-tiles">`;

  // FELT tile (big, red)
  const mortise = recs.mortiseWidth;
  const formulaLine = mortise > 0 ? `(.${mortise.toFixed(3).slice(2)} - .${pin.toFixed(3).slice(2)}) / 2 × 25.4 = ${recs.theoretical ? recs.theoretical.toFixed(2) : '?'} mm` : '';
  const confText = felt.confidence === 'high' ? t('conf_high')
    : felt.confidence === 'medium' ? t('conf_medium')
    : felt.confidence === 'low' ? (mortise > 0 ? t('conf_low_formula') : t('conf_low_theo'))
    : t('conf_none');
  html += `<div class="rec-tile felt-tile confidence-${felt.confidence}">
    <div class="tile-label">${t('tile_felt')}${typeLabel}</div>
    <div class="tile-value">${felt.value ? felt.value.toFixed(2) + ' mm' : '?'}</div>
    <div class="tile-sub">${confText}</div>
    ${formulaLine ? `<div class="tile-source" style="font-family:monospace; font-size:11px;">${formulaLine}</div>` : ''}
    <div class="tile-source">${translateSource(felt.source)}</div>
  </div>`;

  // SIZING tile
  html += `<div class="rec-tile ${sizing.source.includes('Historique') || sizing.source.includes('History') ? 'confidence-medium' : 'confidence-low'}">
    <div class="tile-label">${t('tile_sizing')}</div>
    <div class="tile-value">${sizing.value || '?'}</div>
    <div class="tile-sub">${sizing.value ? caulThickness(sizing.value) : ''}</div>
    <div class="tile-source">${translateSource(sizing.source)}</div>
  </div>`;

  // INTER tile
  html += `<div class="rec-tile ${inter.source.includes('Historique') || inter.source.includes('History') ? 'confidence-medium' : 'confidence-low'}">
    <div class="tile-label">${t('tile_inter')}</div>
    <div class="tile-value">${inter.value || '?'}</div>
    <div class="tile-sub">${inter.value ? caulThickness(inter.value) : ''}</div>
    <div class="tile-source">${translateSource(inter.source)}</div>
  </div>`;

  // FINAL tile
  html += `<div class="rec-tile ${final_.source.includes('Historique') || final_.source.includes('History') ? 'confidence-medium' : 'confidence-low'}">
    <div class="tile-label">${t('tile_final')}</div>
    <div class="tile-value">${final_.value || '?'}</div>
    <div class="tile-sub">${final_.value ? caulThickness(final_.value) : ''}</div>
    <div class="tile-source">${translateSource(final_.source)}</div>
  </div>`;

  html += `</div>`;
  return html;
}

function translateSource(src) {
  if (!src) return '—';
  if (currentLang === 'fr') return src; // already in French
  // Translate source strings that come from computeRecommendations
  return src
    .replace('Formule directe', t('src_formula'))
    .replace('Théorique (Spurlock)', t('src_theo'))
    .replace(/Historique \((\d+) jobs\)/, (_, n) => `${t('src_hist')} (${n} ${t('jobs')})`)
    .replace(/(\d+) parfait/g, (_, n) => `${n} ${t('v_parfait').toLowerCase()}`)
    .replace(/(\d+) ok/g, (_, n) => `${n} ${t('v_ok').toLowerCase()}`)
    .replace(/\+ formule/g, `+ ${t('src_formula_short')}`)
    .replace(/^Spurlock$/, 'Spurlock');
}

function caulThickness(id) {
  if (!id) return '';
  const c = DEFAULT_CAULS.find(c => c.id === id);
  return c ? `.${c.thickness.toFixed(3).slice(2)}"` : '';
}

function renderBoundsBar(felt) {
  if (!felt.maxLache && !felt.minSerre) return '';
  let html = `<div class="bounds-bar">`;
  if (felt.maxLache) html += `<span style="color:#e94560;">${t('bounds_loose')} ${felt.maxLache.toFixed(2)} mm</span>`;
  if (felt.value) html += `<span style="color:#4ecca3; font-weight:700;">${t('bounds_rec')} ${felt.value.toFixed(2)} mm</span>`;
  if (felt.minSerre) html += `<span style="color:#f5a623;">${t('bounds_tight')} ${felt.minSerre.toFixed(2)} mm</span>`;
  html += `</div>`;
  return html;
}

function renderRangeBar(pin, type) {
  const relevant = history.filter(h =>
    !h.outlier && h.felt > 0 &&
    Math.abs(h.pinSize - pin) <= 0.015 &&
    (type === 'any' || h.pinType === type)
  );
  if (relevant.length < 2) return '';

  const allFelts = relevant.map(h => h.felt).sort((a, b) => a - b);
  const min = allFelts[0];
  const max = allFelts[allFelts.length - 1];

  let html = `<div style="background:#16213e; border-radius:8px; padding:12px; margin-bottom:16px;">
    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">${t('range_title')}</div>
    <div class="range-bar">`;

  const seen = new Set();
  for (let f = min; f <= max + 0.001; f += 0.05) {
    const rounded = roundToNearest005(f);
    const key = rounded.toFixed(2);
    if (seen.has(key)) continue;
    seen.add(key);
    const matches = relevant.filter(h => Math.abs(h.felt - rounded) < 0.025);
    if (matches.length > 0) {
      const bestVerdict = matches.some(h => h.verdict === 'parfait') ? 'parfait'
        : matches.some(h => h.verdict === 'ok') ? 'ok'
        : matches.some(h => h.verdict === 'trop_serre') ? 'trop_serre' : 'trop_lache';
      const cls = bestVerdict === 'parfait' || bestVerdict === 'ok' ? 'seg-ok'
        : bestVerdict === 'trop_lache' ? 'seg-loose' : 'seg-tight';
      html += `<div class="range-segment ${cls}" style="flex:1" title="${matches.length} entrée(s) - ${bestVerdict}">${key}</div>`;
    }
  }

  html += `</div></div>`;
  return html;
}

function renderHistoryDetail(relevant) {
  if (relevant.length === 0) return '';

  let html = `<div class="detail-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
    ▼ ${relevant.length} ${t('hist_toggle')}
  </div>`;
  html += `<div class="detail-panel" style="display:none;">`;
  html += `<h4>${t('hist_header')}</h4>`;
  for (const h of relevant) {
    const badge = verdictBadge(h.verdict);
    html += `<div class="history-match">
      <span class="badge ${badge.cls}">${badge.label}</span>
      <span>${h.client ? h.client + ' — ' : ''}${h.piano}</span>
      <span style="color:#4ecca3; font-weight:700;">${h.felt.toFixed(2)} mm</span>
      <span style="color:${h.pinType === 'balance' ? '#4ecca3' : '#e94560'}">${h.pinType === 'balance' ? t('v_bal') : t('v_enf')}</span>
      <span style="color:#888">.${h.pinSize.toFixed(3).slice(2)}"</span>
      ${h.interCaul ? `<span style="color:#888">inter:${h.interCaul}</span>` : ''}
      ${h.finalCaul ? `<span style="color:#888">fin:${h.finalCaul}</span>` : ''}
    </div>`;
  }
  html += `</div>`;
  return html;
}

function renderFeedbackForm(pin, type, recs) {
  const feltOptions = [];
  for (let f = 0.80; f <= 1.60; f += 0.05) {
    feltOptions.push(`<option value="${f.toFixed(2)}" ${recs.felt.value && Math.abs(f - recs.felt.value) < 0.01 ? 'selected' : ''}>${f.toFixed(2)} mm</option>`);
  }

  const sizingOptions = ['', 'MS-125', 'MS-137', 'MS-146', 'MS-162'].map(s =>
    `<option value="${s}" ${s === (recs.sizing.value || '') ? 'selected' : ''}>${s || `-- ${currentLang === 'fr' ? 'Aucun' : 'None'} --`}</option>`
  ).join('');

  return `<div class="feedback-form">
    <h3>${t('fb_title')}</h3>
    <div class="feedback-grid">
      <div class="fg">
        <label>${t('lbl_client')}</label>
        <input type="text" id="fb_client" placeholder="${t('lbl_client')}">
      </div>
      <div class="fg">
        <label>Piano</label>
        <input type="text" id="fb_piano" placeholder="Piano">
      </div>
      <div class="fg">
        <label>${t('lbl_type')}</label>
        <select id="fb_type">
          <option value="enfoncement" ${type === 'enfoncement' ? 'selected' : ''}>${t('lbl_enfoncement')}</option>
          <option value="balance" ${type === 'balance' ? 'selected' : ''}>Balance</option>
        </select>
      </div>
      <div class="fg">
        <label>${t('lbl_pin')}</label>
        <input type="number" id="fb_pin" step="0.001" value="${pin}" readonly style="opacity:0.7">
      </div>
      <div class="fg">
        <label>${t('lbl_felt_star')}</label>
        <select id="fb_felt"><option value="">${t('opt_choose')}</option>${feltOptions.join('')}</select>
      </div>
      <div class="fg">
        <label>Sizing</label>
        <select id="fb_sizing">${sizingOptions}</select>
      </div>
      <div class="fg">
        <label>${t('lbl_sizing_w')}</label>
        <input type="number" id="fb_sizingWidth" step="0.001" placeholder=".227">
      </div>
      <div class="fg">
        <label>${t('lbl_verdict')}</label>
        <select id="fb_verdict">
          <option value="">${t('opt_choose')}</option>
          <option value="parfait">${t('opt_parfait')}</option>
          <option value="ok">OK</option>
          <option value="trop_lache">${t('opt_lache')}</option>
          <option value="trop_serre">${t('opt_serre')}</option>
        </select>
      </div>
      <div class="fg">
        <label>${t('lbl_inter_caul')}</label>
        <select id="fb_inter"></select>
      </div>
      <div class="fg">
        <label>${t('lbl_final_caul')}</label>
        <select id="fb_final"></select>
      </div>
      <div class="fg wide">
        <label>${t('lbl_notes')}</label>
        <input type="text" id="fb_notes" placeholder="${t('fb_observations')}">
      </div>
    </div>
    <div class="feedback-actions">
      <button class="btn btn-save" onclick="saveFeedback()">${t('btn_save_feedback')}</button>
    </div>
  </div>`;
}

function populateFeedbackDropdowns(recs) {
  const caulOptions = DEFAULT_CAULS
    .filter(c => !c.id.startsWith('MS-') && !c.id.startsWith('Mark'))
    .map(c => `<option value="${c.id}" ${c.id === (recs.inter.value || '') ? 'selected' : ''}>${c.id} (.${c.thickness.toFixed(3).slice(2)})</option>`)
    .join('');
  const interHtml = '<option value="">-- Aucune --</option>' + caulOptions;

  const finalCaulOptions = DEFAULT_CAULS
    .filter(c => !c.id.startsWith('MS-') && !c.id.startsWith('Mark'))
    .map(c => `<option value="${c.id}" ${c.id === (recs.final.value || '') ? 'selected' : ''}>${c.id} (.${c.thickness.toFixed(3).slice(2)})</option>`)
    .join('');
  const finalHtml = '<option value="">-- Aucune --</option>' + finalCaulOptions;

  const interEl = document.getElementById('fb_inter');
  const finalEl = document.getElementById('fb_final');
  if (interEl) interEl.innerHTML = interHtml;
  if (finalEl) finalEl.innerHTML = finalHtml;
}

function saveFeedback() {
  const piano = document.getElementById('fb_piano').value.trim();
  const client = document.getElementById('fb_client').value.trim();
  const verdict = document.getElementById('fb_verdict').value;
  const felt = parseFloat(document.getElementById('fb_felt').value) || 0;
  const pin = parseFloat(document.getElementById('fb_pin').value);

  if (!piano) { showToast(t('toast_enter_piano')); return; }
  if (!verdict) { showToast(t('toast_choose_verdict')); return; }
  if (!felt) { showToast(t('toast_choose_felt')); return; }

  history.push({
    id: nextId++,
    client,
    piano,
    pinType: document.getElementById('fb_type').value,
    pinSize: pin,
    sizing: document.getElementById('fb_sizing').value,
    sizingWidth: parseFloat(document.getElementById('fb_sizingWidth').value) || 0,
    felt,
    interCaul: document.getElementById('fb_inter').value,
    finalCaul: document.getElementById('fb_final').value,
    verdict,
    notes: document.getElementById('fb_notes').value.trim(),
    outlier: false,
  });

  saveData();
  showToast(t('toast_saved'));

  // Re-calculate to show updated recommendations
  setTimeout(() => calculate(), 300);
}

// ============================================================
// FORM - ENTRY (full form, kept for detailed entry)
// ============================================================
function populateFormDropdowns() {
  const feltOptions = [];
  for (let f = 0.80; f <= 1.60; f += 0.05) {
    feltOptions.push(`<option value="${f.toFixed(2)}">${f.toFixed(2)} mm</option>`);
  }
  const feltHtml = '<option value="">-- Choisir --</option>' + feltOptions.join('');

  const caulOptions = DEFAULT_CAULS
    .filter(c => !c.id.startsWith('MS-'))
    .map(c => `<option value="${c.id}">${c.id} (.${c.thickness.toFixed(3).slice(2)})</option>`)
    .join('');
  const caulHtml = '<option value="">-- Aucune --</option>' + caulOptions;

  ['bal', 'enf'].forEach(prefix => {
    document.getElementById(`f_${prefix}_felt`).innerHTML = feltHtml;
    document.getElementById(`f_${prefix}_interCaul`).innerHTML = caulHtml;
    document.getElementById(`f_${prefix}_finalCaul`).innerHTML = caulHtml;
  });
}

function addEntry() {
  const piano = document.getElementById('f_piano').value.trim();
  const client = document.getElementById('f_client').value.trim();

  if (!piano) { showToast(t('toast_enter_piano')); return; }

  let added = 0;

  const balPin = parseFloat(document.getElementById('f_bal_pinSize').value);
  const balVerdict = document.getElementById('f_bal_verdict').value;
  if (balPin && balVerdict) {
    history.push({
      id: nextId++, client, piano, pinType: 'balance', pinSize: balPin,
      sizing: document.getElementById('f_bal_sizing').value,
      sizingWidth: parseFloat(document.getElementById('f_bal_sizingWidth').value) || 0,
      felt: parseFloat(document.getElementById('f_bal_felt').value) || 0,
      interCaul: document.getElementById('f_bal_interCaul').value,
      finalCaul: document.getElementById('f_bal_finalCaul').value,
      verdict: balVerdict,
      notes: document.getElementById('f_bal_notes').value.trim(),
      outlier: false,
    });
    added++;
  }

  const enfPin = parseFloat(document.getElementById('f_enf_pinSize').value);
  const enfVerdict = document.getElementById('f_enf_verdict').value;
  if (enfPin && enfVerdict) {
    history.push({
      id: nextId++, client, piano, pinType: 'enfoncement', pinSize: enfPin,
      sizing: document.getElementById('f_enf_sizing').value,
      sizingWidth: parseFloat(document.getElementById('f_enf_sizingWidth').value) || 0,
      felt: parseFloat(document.getElementById('f_enf_felt').value) || 0,
      interCaul: document.getElementById('f_enf_interCaul').value,
      finalCaul: document.getElementById('f_enf_finalCaul').value,
      verdict: enfVerdict,
      notes: document.getElementById('f_enf_notes').value.trim(),
      outlier: false,
    });
    added++;
  }

  if (added === 0) {
    showToast(t('toast_fill_side'));
    return;
  }

  saveData();
  showToast(`${added} ${t('toast_added')}`);
  clearForm();
}

function clearForm() {
  ['f_client', 'f_piano'].forEach(id => document.getElementById(id).value = '');
  ['bal', 'enf'].forEach(prefix => {
    document.getElementById(`f_${prefix}_pinSize`).value = '';
    document.getElementById(`f_${prefix}_sizingWidth`).value = '';
    document.getElementById(`f_${prefix}_notes`).value = '';
    ['sizing', 'felt', 'interCaul', 'finalCaul', 'verdict'].forEach(field => {
      document.getElementById(`f_${prefix}_${field}`).selectedIndex = 0;
    });
  });
}

function editEntry(id) {
  const entry = history.find(h => h.id === id);
  if (!entry) return;

  showTab('entry');
  clearForm();

  document.getElementById('f_client').value = entry.client || '';
  document.getElementById('f_piano').value = entry.piano;

  const prefix = entry.pinType === 'balance' ? 'bal' : 'enf';
  document.getElementById(`f_${prefix}_pinSize`).value = entry.pinSize;
  document.getElementById(`f_${prefix}_sizing`).value = entry.sizing || '';
  if (entry.sizingWidth) document.getElementById(`f_${prefix}_sizingWidth`).value = entry.sizingWidth;
  document.getElementById(`f_${prefix}_felt`).value = entry.felt ? entry.felt.toFixed(2) : '';
  document.getElementById(`f_${prefix}_interCaul`).value = entry.interCaul || '';
  document.getElementById(`f_${prefix}_finalCaul`).value = entry.finalCaul || '';
  document.getElementById(`f_${prefix}_verdict`).value = entry.verdict;
  document.getElementById(`f_${prefix}_notes`).value = entry.notes || '';

  history = history.filter(h => h.id !== id);
  saveData();
  showToast(t('toast_modify'));
}

// ============================================================
// DATA TABLE
// ============================================================
function renderTable() {
  const verdictFilter = document.getElementById('filterVerdict').value;
  const pianoFilter = document.getElementById('filterPiano').value.toLowerCase();
  const grouped = document.getElementById('groupView').checked;

  let filtered = history;
  if (verdictFilter !== 'all') filtered = filtered.filter(h => h.verdict === verdictFilter);
  if (pianoFilter) filtered = filtered.filter(h => h.piano.toLowerCase().includes(pianoFilter) || (h.client && h.client.toLowerCase().includes(pianoFilter)));

  document.getElementById('dataCount').textContent = `${filtered.length} / ${history.length} ${t('entries')}`;

  const tbody = document.getElementById('dataBody');

  function renderRow(h, showPiano) {
    return `<tr class="${h.outlier ? 'outlier' : ''}">
      <td><input type="checkbox" class="outlier-cb" ${h.outlier ? 'checked' : ''} onchange="toggleOutlier(${h.id})"></td>
      <td>${showPiano ? `<strong>${h.client ? h.client + '</strong> — ' : '</strong>'}${h.piano}` : ''}</td>
      <td style="color:${h.pinType === 'balance' ? '#4ecca3' : '#e94560'}">${h.pinType === 'balance' ? t('v_bal') : t('v_enf')}</td>
      <td>.${h.pinSize.toFixed(3).slice(2)}</td>
      <td>${h.sizing || '—'}</td>
      <td>${h.sizingWidth ? '.' + h.sizingWidth.toFixed(3).slice(2) : '—'}</td>
      <td style="${h.felt ? 'color:#fff; background:#e94560; font-weight:700; font-size:15px; text-align:center; border-radius:4px; padding:4px 8px;' : ''}">${h.felt ? h.felt.toFixed(2) + ' mm' : '—'}</td>
      <td>${h.interCaul || '—'}</td>
      <td>${h.finalCaul || '—'}</td>
      <td><span class="badge ${verdictBadge(h.verdict).cls}">${verdictBadge(h.verdict).label}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${h.notes}">${h.notes || ''}</td>
      <td>
        <button class="delete-btn" onclick="editEntry(${h.id})" title="Modifier" style="color:#4ecca3;">&#9998;</button>
        <button class="delete-btn" onclick="deleteEntry(${h.id})" title="Supprimer">&times;</button>
      </td>
    </tr>`;
  }

  if (grouped) {
    const groups = {};
    for (const h of filtered) {
      const key = (h.client || '') + '|||' + h.piano;
      if (!groups[key]) groups[key] = [];
      groups[key].push(h);
    }

    let html = '';
    for (const key of Object.keys(groups)) {
      const entries = groups[key];
      entries.sort((a, b) => (a.pinType === 'balance' ? 0 : 1) - (b.pinType === 'balance' ? 0 : 1));
      entries.forEach((h, i) => {
        html += renderRow(h, i === 0);
      });
      html += `<tr><td colspan="12" style="padding:2px; background:#0f3460;"></td></tr>`;
    }
    tbody.innerHTML = html;
  } else {
    tbody.innerHTML = filtered.map(h => renderRow(h, true)).join('');
  }
}

function toggleOutlier(id) {
  const entry = history.find(h => h.id === id);
  if (entry) { entry.outlier = !entry.outlier; saveData(); renderTable(); }
}

function deleteEntry(id) {
  if (confirm(t('confirm_delete'))) {
    history = history.filter(h => h.id !== id);
    saveData();
    renderTable();
    showToast(t('toast_deleted'));
  }
}

// ============================================================
// STOCK
// ============================================================
function renderStock() {
  const grid = document.getElementById('stockGrid');
  grid.innerHTML = cauls.map(c => `
    <div class="stock-card">
      <div class="name">${c.id}</div>
      <div class="thickness">.${c.thickness.toFixed(3).slice(2)}" — ${(c.thickness * 25.4).toFixed(2)} mm</div>
      <div class="qty ${c.qty < 20 ? 'low' : ''}">${c.qty}</div>
    </div>
  `).join('');
}

// ============================================================
// IMPORT/EXPORT
// ============================================================
function exportData() {
  const data = { history, cauls, exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `felt-calculator-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.history) {
        history = data.history;
        nextId = Math.max(...history.map(h => h.id), 99) + 1;
      }
      if (data.cauls) cauls = data.cauls;
      saveData();
      renderTable();
      renderStock();
      showToast(`${t('toast_imported')} ${history.length} ${t('entries')}`);
    } catch (err) {
      showToast(`${t('toast_import_err')} ${err.message}`);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ============================================================
// UTILS
// ============================================================
function roundToNearest005(val) {
  return Math.round(val / 0.05) * 0.05;
}

function verdictBadge(verdict) {
  switch (verdict) {
    case 'parfait': return { cls: 'badge-parfait', label: t('v_parfait') };
    case 'ok': return { cls: 'badge-ok', label: t('v_ok') };
    case 'trop_lache': return { cls: 'badge-lache', label: t('v_lache') };
    case 'trop_serre': return { cls: 'badge-serre', label: t('v_serre') };
    default: return { cls: '', label: verdict };
  }
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ============================================================
// INIT
// ============================================================
loadData();
populateFormDropdowns();
setLang(currentLang);
</script>

</body>
</html>
