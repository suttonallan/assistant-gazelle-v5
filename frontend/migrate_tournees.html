<!DOCTYPE html>
<html>
<head>
    <title>Migration Tourn√©es - IDs Gazelle</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        pre { background: #f9f9f9; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .primary { background: #4CAF50; color: white; border: none; }
        .danger { background: #f44336; color: white; border: none; }
        .info { background: #2196F3; color: white; border: none; }
        #output { white-space: pre-wrap; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Migration des Tourn√©es - IDs Gazelle</h1>

        <h3>√âtat actuel:</h3>
        <pre id="current-state"></pre>

        <h3>Actions:</h3>
        <button class="info" onclick="showCurrentState()">üìã Afficher l'√©tat actuel</button>
        <button class="primary" onclick="migrateTournees()">üîÑ Migrer les IDs vers gazelleId</button>
        <button class="danger" onclick="clearAll()">üóëÔ∏è Tout effacer (r√©initialiser)</button>

        <h3>Log:</h3>
        <pre id="output"></pre>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let pianosData = [];

        async function loadPianos() {
            try {
                const response = await fetch(`${API_URL}/vincent-dindy/pianos?include_inactive=true`);
                const data = await response.json();
                pianosData = data.pianos || [];
                log(`‚úÖ ${pianosData.length} pianos charg√©s depuis l'API`, 'success');
                return pianosData;
            } catch (err) {
                log(`‚ùå Erreur chargement pianos: ${err.message}`, 'error');
                return [];
            }
        }

        function log(message, type = '') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}\n`;
            output.textContent += line;
            if (type) {
                output.className = type;
            }
        }

        async function showCurrentState() {
            const tournees = JSON.parse(localStorage.getItem('tournees_accords') || '[]');
            const stateDiv = document.getElementById('current-state');

            let state = `Nombre de tourn√©es: ${tournees.length}\n\n`;

            tournees.forEach((t, idx) => {
                state += `Tourn√©e #${idx + 1}: ${t.nom}\n`;
                state += `  ID: ${t.id}\n`;
                state += `  Date: ${t.date_debut}\n`;
                state += `  Status: ${t.status}\n`;
                state += `  Pianos (${(t.piano_ids || []).length}):\n`;
                (t.piano_ids || []).forEach(pid => {
                    state += `    - ${pid}\n`;
                });
                state += '\n';
            });

            stateDiv.textContent = state;
            log('√âtat actuel affich√©', 'info');
        }

        async function migrateTournees() {
            log('üîÑ D√©but de la migration...', 'info');

            // Charger les pianos depuis l'API
            await loadPianos();

            if (pianosData.length === 0) {
                log('‚ùå Aucun piano charg√©, migration annul√©e', 'error');
                return;
            }

            // Charger les tourn√©es
            const tournees = JSON.parse(localStorage.getItem('tournees_accords') || '[]');
            log(`üìã ${tournees.length} tourn√©es √† migrer`, 'info');

            // Cr√©er un mapping serial -> gazelleId
            const serialToGazelleId = {};
            pianosData.forEach(p => {
                if (p.serie && p.gazelleId) {
                    serialToGazelleId[p.serie] = p.gazelleId;
                }
            });

            log(`üó∫Ô∏è  ${Object.keys(serialToGazelleId).length} mappings serial->gazelleId cr√©√©s`, 'info');

            // Migrer chaque tourn√©e
            let migratedCount = 0;
            const migratedTournees = tournees.map(tournee => {
                const oldPianoIds = tournee.piano_ids || [];
                const newPianoIds = [];

                oldPianoIds.forEach(oldId => {
                    // Si l'ID ressemble √† un gazelleId (commence par "ins_"), le garder
                    if (oldId.startsWith('ins_')) {
                        newPianoIds.push(oldId);
                    }
                    // Sinon, essayer de le mapper vers un gazelleId
                    else if (serialToGazelleId[oldId]) {
                        const newId = serialToGazelleId[oldId];
                        newPianoIds.push(newId);
                        log(`  ‚úì Migr√©: ${oldId} ‚Üí ${newId}`, 'success');
                        migratedCount++;
                    }
                    // Si on ne trouve pas de mapping, chercher par serial dans les pianos
                    else {
                        const piano = pianosData.find(p => p.serie === oldId || p.id === oldId);
                        if (piano && piano.gazelleId) {
                            newPianoIds.push(piano.gazelleId);
                            log(`  ‚úì Trouv√© par recherche: ${oldId} ‚Üí ${piano.gazelleId}`, 'success');
                            migratedCount++;
                        } else {
                            log(`  ‚ö†Ô∏è  ID non trouv√©, conserv√©: ${oldId}`, 'warning');
                            newPianoIds.push(oldId);
                        }
                    }
                });

                return {
                    ...tournee,
                    piano_ids: newPianoIds
                };
            });

            // Sauvegarder
            localStorage.setItem('tournees_accords', JSON.stringify(migratedTournees));

            log(`\n‚úÖ Migration termin√©e!`, 'success');
            log(`   ${migratedCount} IDs migr√©s vers gazelleId`, 'success');

            // Afficher le nouvel √©tat
            await showCurrentState();
        }

        function clearAll() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUTES les tourn√©es ?')) {
                return;
            }

            localStorage.removeItem('tournees_accords');
            log('üóëÔ∏è Toutes les tourn√©es ont √©t√© supprim√©es', 'warning');
            showCurrentState();
        }

        // Charger l'√©tat au d√©marrage
        window.addEventListener('load', () => {
            showCurrentState();
            loadPianos();
        });
    </script>
</body>
</html>
