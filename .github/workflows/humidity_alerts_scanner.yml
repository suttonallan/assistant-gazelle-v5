name: üå°Ô∏è Scan Alertes Humidit√©

on:
  schedule:
    # 4 fois par jour: 8h, 12h, 16h, 20h (heure Montr√©al = UTC-5)
    # UTC: 13h, 17h, 21h, 01h
    - cron: '0 13 * * *'  # 8h AM Montr√©al
    - cron: '0 17 * * *'  # 12h PM Montr√©al
    - cron: '0 21 * * *'  # 4h PM Montr√©al
    - cron: '0 1 * * *'   # 8h PM Montr√©al

  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  scan-humidity-alerts:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          pip install requests python-dotenv

      - name: üîç Scan alertes humidit√©
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 -c "
          from modules.alerts import HumidityScanner
          import sys

          print('üå°Ô∏è SCAN ALERTES HUMIDIT√â')
          print('=' * 70)

          try:
              scanner = HumidityScanner()
              # Scanner 200 entries (suffisant pour 6h de services)
              stats = scanner.scan_timeline_entries(limit=200)

              print('\nüìä R√âSULTATS:')
              print(f'  Scann√©es: {stats[\"scanned\"]}')
              print(f'  Skipped: {stats[\"skipped\"]}')
              print(f'  Alertes: {stats[\"alerts_found\"]}')
              print(f'  Notifications: {stats[\"notifications_sent\"]}')
              print(f'  Erreurs: {stats[\"errors\"]}')

              if stats['errors'] > 0:
                  print(f'\n‚ö†Ô∏è {stats[\"errors\"]} erreur(s) d√©tect√©e(s)')
                  sys.exit(1)

              print('\n‚úÖ Scan termin√© avec succ√®s!')

          except Exception as e:
              print(f'\n‚ùå ERREUR: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: üìß Notify on failure
        if: failure()
        run: |
          echo "‚ùå Le scan d'alertes humidit√© a √©chou√©"
          echo "V√©rifier les logs GitHub Actions"
