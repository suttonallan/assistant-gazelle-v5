name: Full Gazelle Sync (Nightly)

on:
  schedule:
    # ExÃ©cuter tous les jours Ã  2h00 UTC (22h00 heure de MontrÃ©al la veille en hiver)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Permet d'exÃ©cuter manuellement depuis GitHub

jobs:
  sync-all-gazelle-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de 30 minutes pour la sync complÃ¨te

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run full Gazelle sync
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        GAZELLE_CLIENT_ID: ${{ secrets.GAZELLE_CLIENT_ID }}
        GAZELLE_CLIENT_SECRET: ${{ secrets.GAZELLE_CLIENT_SECRET }}
      run: |
        echo "ğŸ”„ DÃ©marrage de la synchronisation complÃ¨te Gazelle â†’ Supabase"
        echo "ğŸ“… $(date)"
        echo ""
        python3 modules/sync_gazelle/sync_to_supabase.py

    - name: Generate Timeline Report
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo ""
        echo "ğŸ“Š GÃ©nÃ©ration du rapport Timeline Google Sheets"
        echo "ğŸ“… $(date)"

        # CrÃ©er le fichier credentials Google depuis le secret
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > /tmp/google_credentials.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_credentials.json

        # GÃ©nÃ©rer le rapport
        python3 -c "from modules.reports.service_reports import run_reports; run_reports(append=False)"

        # Nettoyer le fichier credentials
        rm /tmp/google_credentials.json

        echo "âœ… Rapport Timeline gÃ©nÃ©rÃ©"

    - name: Report results
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Synchronisation complÃ¨te terminÃ©e"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… DonnÃ©es synchronisÃ©es:"
        echo "   â€¢ Users/Techniciens"
        echo "   â€¢ Clients"
        echo "   â€¢ Contacts"
        echo "   â€¢ Pianos"
        echo "   â€¢ Rendez-vous (Appointments)"
        echo "   â€¢ Timeline Entries"
        echo ""
        echo "ğŸ“ˆ Consultez les logs dans le Dashboard:"
        echo "   Notifications â†’ TÃ¢ches & Imports â†’ Logs de synchronisation"
        echo ""
        echo "â° Prochaine sync automatique: demain Ã  2h00 UTC (22h MontrÃ©al)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
