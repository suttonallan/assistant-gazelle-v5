name: ğŸ“… Sync Appointments Horaire (7h-21h)

on:
  schedule:
    # ExÃ©cuter toutes les heures entre 7h et 21h heure MontrÃ©al
    # 7h-21h MontrÃ©al (EST/EDT) = 12h-2h UTC (hiver) ou 11h-1h UTC (Ã©tÃ©)
    # On couvre 11h-2h UTC pour couvrir les deux fuseaux horaires
    - cron: '0 11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2 * * *'
  workflow_dispatch:  # Permet d'exÃ©cuter manuellement depuis GitHub

jobs:
  sync-appointments-hourly:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Timeout de 10 minutes pour la sync appointments

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # VÃ©rifier que sendgrid est bien installÃ© (requis pour les notifications)
        python -c "import sendgrid; print(f'âœ… sendgrid version: {sendgrid.__version__}')" || (echo "âŒ sendgrid non installÃ© - installation forcÃ©e" && pip install sendgrid>=6.12.0)

    - name: Sync Appointments (dÃ©tection RV derniÃ¨re minute)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        GAZELLE_CLIENT_ID: ${{ secrets.GAZELLE_CLIENT_ID }}
        GAZELLE_CLIENT_SECRET: ${{ secrets.GAZELLE_CLIENT_SECRET }}
      run: |
        echo "ğŸ”„ Sync Appointments Horaire - DÃ©tection RV derniÃ¨re minute"
        echo "ğŸ“… $(date)"
        echo "ğŸ• Heure UTC: $(date -u)"
        echo ""
        
        # ExÃ©cuter la sync appointments uniquement
        # VÃ©rifier l'heure locale (MontrÃ©al) et n'exÃ©cuter qu'entre 7h et 21h
        # Cela dÃ©tectera les changements de technicien et insÃ©rera dans late_assignment_queue
        python3 -c "
        import sys
        from pathlib import Path
        from datetime import datetime
        import pytz
        
        sys.path.insert(0, str(Path.cwd()))
        
        # VÃ©rifier l'heure locale (MontrÃ©al)
        montreal_tz = pytz.timezone('America/Montreal')
        now_montreal = datetime.now(montreal_tz)
        current_hour = now_montreal.hour
        
        print(f'ğŸ• Heure MontrÃ©al: {now_montreal.strftime(\"%Y-%m-%d %H:%M:%S %Z\")}')
        print(f'ğŸ• Heure actuelle: {current_hour}h')
        
        # Ne s'exÃ©cuter qu'entre 7h et 21h (heure MontrÃ©al)
        if current_hour < 7 or current_hour >= 21:
            print(f'â­ï¸  Heure hors plage (7h-21h), sync ignorÃ©e')
            print(f'   Prochaine sync: Ã  7h heure MontrÃ©al')
            sys.exit(0)
        
        print('âœ… Heure dans la plage 7h-21h, sync appointments...')
        
        from modules.sync_gazelle.sync_to_supabase import GazelleToSupabaseSync
        
        syncer = GazelleToSupabaseSync(incremental_mode=True)
        appointments_count = syncer.sync_appointments()
        print(f'âœ… {appointments_count} rendez-vous synchronisÃ©s')
        print('âœ… DÃ©tection des changements de technicien effectuÃ©e')
        print('âœ… Les alertes Late Assignment ont Ã©tÃ© insÃ©rÃ©es dans la queue si nÃ©cessaire')
        "

    - name: Report results
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“… Sync Appointments Horaire terminÃ©e"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Rendez-vous synchronisÃ©s"
        echo "âœ… DÃ©tection des changements de technicien effectuÃ©e"
        echo "âœ… Alertes Late Assignment insÃ©rÃ©es dans la queue si nÃ©cessaire"
        echo ""
        echo "ğŸ“§ Les emails seront envoyÃ©s automatiquement (toutes les 5 min)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
